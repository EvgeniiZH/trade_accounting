name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/evgeniizh/trade_accounting:latest
            ghcr.io/evgeniizh/trade_accounting:${{ github.sha }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy to VPS
        env:
          IMAGE_NAME: ghcr.io/evgeniizh/trade_accounting:latest
        run: |
          ssh -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} << 'EOF'
            set -e
            echo "==> Переход в директорию проекта"
            cd /root/trade_accounting

            echo "==> Сброс локальных изменений"
            git reset --hard HEAD

            echo "==> Обновление кода"
            git pull origin main

            echo "==> Логин в GitHub Container Registry"
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            echo "==> Скачивание нового образа"
            docker pull ghcr.io/evgeniizh/trade_accounting:latest

            echo "==> Настройка окружения"
            export GITHUB_REPOSITORY="evgeniizh/trade_accounting"
            export IMAGE_TAG=latest
            
            echo "==> Остановка старых контейнеров"
            docker compose down

            echo "==> Запуск обновлённых контейнеров"
            docker compose up -d

            echo "==> Миграции"
            docker compose exec -T web python manage.py migrate --noinput

            echo "==> Сборка статики"
            docker compose exec -T web python manage.py collectstatic --noinput

            echo "==> Копирование STATIC в /var/www"
            mkdir -p /var/www/trade_accounting/staticfiles
            docker compose exec -T web cp -r /app/staticfiles/. /var/www/trade_accounting/staticfiles/

            echo "==> Копирование MEDIA в /var/www"
            mkdir -p /var/www/trade_accounting/media
            docker compose exec -T web cp -r /app/media/. /var/www/trade_accounting/media/

            echo "==> Обновление конфигурации nginx"
            cp deploy/nginx/django.conf /etc/nginx/sites-available/django
            ln -sf /etc/nginx/sites-available/django /etc/nginx/sites-enabled/django

            echo "==> Проверка nginx"
            nginx -t

            echo "==> Перезапуск nginx"
            systemctl reload nginx

            echo "✅ Деплой завершён успешно!"
          EOF
