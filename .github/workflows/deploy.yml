name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up SSH agent
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy to VPS
        run: |
          ssh -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} << 'EOF'
            set -e
            echo "==> Переход в проект"
            cd /root/trade_accounting

            echo "==> Сброс локальных изменений"
            git reset --hard HEAD

            echo "==> Получение свежего кода"
            git pull origin main

            echo "==> Пересборка Docker"
            docker compose build --no-cache
            docker compose up -d

            echo "==> Выполнение миграций"
            docker compose exec web python manage.py migrate --noinput

            echo "==> Сбор статики"
            docker compose exec web python manage.py collectstatic --noinput

            echo "==> Обновление nginx-конфига"
            cp deploy/nginx/django.conf /etc/nginx/sites-available/django


            ln -sf /etc/nginx/sites-available/django /etc/nginx/sites-enabled/django

            echo "==> Проверка конфигурации nginx"
            nginx -t

            echo "==> Перезапуск nginx"
            systemctl reload nginx

            echo "✅ Деплой завершён успешно!"
          EOF
