{% extends 'base.html' %}

{% block title %}–î–µ—Ç–∞–ª–∏ —Ä–∞—Å—á—ë—Ç–∞{% endblock %}

{% block content %}
    <div class="container my-4">
        <h2 class="mb-4 text-primary">üìä {{ calculation.title }}</h2>

        <div class="card p-3 bg-light border">
            <h4>üì¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞—Å—á—ë—Ç–µ</h4>
            <p><strong>–ù–∞—Ü–µ–Ω–∫–∞:</strong> {{ calculation.markup|floatformat:2 }}%</p>
            <p><strong>–°—Ç–æ–∏–º–æ—Å—Ç—å –±–µ–∑ –Ω–∞—Ü–µ–Ω–∫–∏:</strong> <span
                    id="total-without-markup">{{ calculation.total_price_without_markup|floatformat:2 }}</span> ‚ÇΩ</p>
            <p><strong>–°—Ç–æ–∏–º–æ—Å—Ç—å —Å –Ω–∞—Ü–µ–Ω–∫–æ–π:</strong> <span
                    id="total-with-markup">{{ calculation.total_price_with_markup|floatformat:2 }}</span> ‚ÇΩ</p>
        </div>

        <h3 class="mt-4">üì¶ –¢–æ–≤–∞—Ä—ã –≤ —Ä–∞—Å—á—ë—Ç–µ</h3>
        <div class="table-responsive">
            <table class="table table-bordered table-hover" id="calculation-table">
                <thead class="table-light">
                <tr>
                    <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                    <th>–¶–µ–Ω–∞</th>
                    <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                    <th>–ò—Ç–æ–≥–æ</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
                </thead>
                <tbody>
                {% for item in calculation.items.all %}
                    <tr data-item-id="{{ item.id }}">
                        <td>{{ item.item.name }}</td>
                        <td class="unit-price">{{ item.item.price|floatformat:2 }}</td>
                        <td>
                            <input type="number" name="quantity_{{ item.id }}" value="{{ item.quantity }}" min="1"
                                   class="form-control quantity-input">
                        </td>
                        <td class="total-price fw-bold">{{ item.total_price|floatformat:2 }}</td>
                        <td>
                            <form method="post">
                                {% csrf_token %}
                                <button type="submit" name="delete_item" value="{{ item.id }}"
                                        class="btn btn-danger btn-sm">
                                    üóë –£–¥–∞–ª–∏—Ç—å
                                </button>
                            </form>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä -->
        <h3 class="mt-4">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h3>
        <form method="post" class="row g-3">
            {% csrf_token %}
            <div class="col-md-6">
                <select name="item_id" class="form-control">
                    {% for item in items %}
                        <option value="{{ item.id }}">{{ item.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <input type="number" name="markup" value="{{ calculation.markup|floatformat:1 }}" class="form-control"
                       step="1">

            </div>
            <div class="col-md-3">
                <button type="submit" name="add_item" class="btn btn-success">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </form>

        <!-- –ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞—Ü–µ–Ω–∫—É -->
        <h3 class="mt-4">‚úè –ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞—Ü–µ–Ω–∫—É</h3>
        <form method="post" class="row g-3">
            {% csrf_token %}
            <div class="col-md-4">
                <input type="number" name="markup" value="{{ calculation.markup|floatformat:1 }}" class="form-control">
            </div>
            <div class="col-md-4">
                <button type="submit" name="update_markup" class="btn btn-warning">–û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
        </form>
        <div class="mt-4">
            <form method="post">
                {% csrf_token %}
                <button type="submit" name="save_calculation" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å—á–µ—Ç</button>
            </form>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const table = document.getElementById('calculation-table');
            const totalWithoutMarkupElement = document.getElementById('total-without-markup');
            const totalWithMarkupElement = document.getElementById('total-with-markup');
            const markup = parseFloat({{ calculation.markup|default:0 }});

            const recalculateRowTotal = (row) => {
                const unitPrice = parseFloat(row.querySelector('.unit-price').textContent);
                const quantity = parseInt(row.querySelector('.quantity-input').value);
                const totalPriceCell = row.querySelector('.total-price');

                if (!isNaN(unitPrice) && !isNaN(quantity)) {
                    const rowTotal = unitPrice * quantity;
                    totalPriceCell.textContent = rowTotal.toFixed(2);
                    return rowTotal;
                }
                return 0;
            };

            const recalculateOverallTotals = () => {
                let totalWithoutMarkup = 0;

                table.querySelectorAll('tr[data-item-id]').forEach(row => {
                    totalWithoutMarkup += recalculateRowTotal(row);
                });

                const totalWithMarkup = totalWithoutMarkup + (totalWithoutMarkup * (markup / 100));

                totalWithoutMarkupElement.textContent = totalWithoutMarkup.toFixed(2);
                totalWithMarkupElement.textContent = totalWithMarkup.toFixed(2);
            };

            table.addEventListener('input', (event) => {
                if (event.target.classList.contains('quantity-input')) {
                    recalculateOverallTotals();
                }
            });

            recalculateOverallTotals();
        });
    </script>
{% endblock %}
