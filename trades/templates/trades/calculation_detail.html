{% extends 'base.html' %}
{% load l10n %}

{% block title %}–î–µ—Ç–∞–ª–∏ —Ä–∞—Å—á—ë—Ç–∞{% endblock %}

{% block content %}
    <div class="container my-4">
        <h2 class="mb-4 text-primary">üìä {{ calculation.title }}</h2>

        <div class="card p-3 bg-light border mb-4">
            <h4>üì¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞—Å—á—ë—Ç–µ</h4>
            <p><strong>–ù–∞—Ü–µ–Ω–∫–∞:</strong> {{ calculation.markup|floatformat:0 }}%</p>
            <p>
                <strong>–°—Ç–æ–∏–º–æ—Å—Ç—å –±–µ–∑ –Ω–∞—Ü–µ–Ω–∫–∏:</strong>
                <span id="total-without-markup">{{ calculation.total_price_without_markup|floatformat:2 }}</span> ‚ÇΩ
            </p>
            <p>
                <strong>–°—Ç–æ–∏–º–æ—Å—Ç—å —Å –Ω–∞—Ü–µ–Ω–∫–æ–π:</strong>
                <span id="total-with-markup">{{ calculation.total_price_with_markup|floatformat:2 }}</span> ‚ÇΩ
            </p>
        </div>

        <!-- –ï–¥–∏–Ω–∞—è —Ñ–æ—Ä–º–∞ –¥–ª—è –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π -->
        <form method="post" action="{% url 'calculation_detail' calculation.id %}">
            {% csrf_token %}

            <h3 class="mt-4">üì¶ –¢–æ–≤–∞—Ä—ã –≤ —Ä–∞—Å—á—ë—Ç–µ</h3>
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="calculation-table">
                    <thead class="table-light">
                    <tr>
                        <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                        <th>–¶–µ–Ω–∞</th>
                        <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                        <th>–ò—Ç–æ–≥–æ</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for item in calculation.items.all %}
                        <tr data-item-id="{{ item.id }}">
                            <td>{{ item.item.name }}</td>
                            <td class="unit-price">{{ item.item.price|floatformat:2 }}</td>
                            <td>
                                <input type="number"
                                       name="quantity_{{ item.id }}"
                                       value="{{ item.quantity }}"
                                       min="1"
                                       class="form-control quantity-input">
                            </td>
                            <td class="total-price fw-bold">{{ item.total_price|floatformat:2 }}</td>
                            <td>
                                <button type="submit" name="delete_item" value="{{ item.id }}"
                                        class="btn btn-danger btn-sm">
                                    üóë –£–¥–∞–ª–∏—Ç—å
                                </button>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            <h3 class="mt-4">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h3>
            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <select name="item_id" class="form-select">
                        {% for item in items %}
                            <option value="{{ item.id }}">{{ item.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="number" name="quantity" value="1" class="form-control" step="1" min="1">
                </div>
                <div class="col-md-3">
                    <button type="submit" name="add_item" class="btn btn-success">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
            </div>
            <h3 class="mt-4">‚úè –ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞—Ü–µ–Ω–∫—É</h3>
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <input type="number"
                           name="markup"
                           value="{{ calculation.markup|floatformat:1 }}"
                           class="form-control"
                           min="0"
                           step="1">
                </div>

            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å—á–µ—Ç" —Ç–µ–ø–µ—Ä—å —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∞ –≤ —Å–∞–º–æ–º –∫–æ–Ω—Ü–µ —Ñ–æ—Ä–º—ã -->
            <div class="mt-4">
                <button type="submit" name="save_calculation" class="btn btn-primary w-100">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å—á–µ—Ç
                </button>

            </div>
            <div class="mt-5">
                <form method="post" action="{% url 'save_calculation_snapshot' calculation.id %}"
                      style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–Ω–∏–º–æ–∫ —Ä–∞—Å—á—ë—Ç–∞</button>
                </form>
            </div>
        </form>
    </div>

    {#    <script>#}
    {#        document.addEventListener('DOMContentLoaded', () => {#}
    {#            const table = document.getElementById('calculation-table');#}
    {#            const totalWithoutMarkupElement = document.getElementById('total-without-markup');#}
    {#            const totalWithMarkupElement = document.getElementById('total-with-markup');#}
    {#            const markup = parseFloat("{{ calculation.markup|default:'0'|floatformat:2 }}");#}
    {##}
    {#            const recalculateRowTotal = (row) => {#}
    {#                const unitPrice = parseFloat(row.querySelector('.unit-price').textContent.replace(',', '.'));#}
    {#                const quantity = parseInt(row.querySelector('.quantity-input').value);#}
    {#                const totalPriceCell = row.querySelector('.total-price');#}
    {#                if (!isNaN(unitPrice) && !isNaN(quantity)) {#}
    {#                    const rowTotal = unitPrice * quantity;#}
    {#                    totalPriceCell.textContent = rowTotal.toFixed(2);#}
    {#                    return rowTotal;#}
    {#                }#}
    {#                return 0;#}
    {#            };#}
    {##}
    {#            const recalculateOverallTotals = () => {#}
    {#                let totalWithoutMarkup = 0;#}
    {#                table.querySelectorAll('tr[data-item-id]').forEach(row => {#}
    {#                    totalWithoutMarkup += recalculateRowTotal(row);#}
    {#                });#}
    {#                const totalWithMarkup = totalWithoutMarkup + (totalWithoutMarkup * (markup / 100));#}
    {#                totalWithoutMarkupElement.textContent = totalWithoutMarkup.toFixed(2);#}
    {#                totalWithMarkupElement.textContent = totalWithMarkup.toFixed(2);#}
    {#            };#}
    {##}
    {#            table.addEventListener('input', (event) => {#}
    {#                if (event.target.classList.contains('quantity-input')) {#}
    {#                    recalculateOverallTotals();#}
    {#                }#}
    {#            });#}
    {##}
    {#            recalculateOverallTotals();#}
    {#        });#}
    {#    </script>#}
{% endblock %}
